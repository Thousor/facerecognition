<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Management</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; text-align: center; }
        h1 { color: #333; }
        #user_list { list-style: none; padding: 0; margin: 20px auto; max-width: 600px; border: 1px solid #eee; border-radius: 8px; }
        #user_list li { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        #user_list li:last-child { border-bottom: none; }
        #user_list li:hover { background-color: #f9f9f9; }
        .user-name { font-size: 1.2em; font-weight: bold; }
        .actions button { margin-left: 10px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; }
        .actions .view-btn { background-color: #007bff; color: white; }
        .actions .view-btn:hover { background-color: #0056b3; }
        .actions .delete-btn { background-color: #dc3545; color: white; }
        .actions .delete-btn:hover { background-color: #c82333; }
        .back-link { display: inline-block; margin-top: 20px; padding: 10px 20px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 5px; }
        .back-link:hover { background-color: #5a6268; }
    </style>
</head>
<body>
    <h1>Registered Users</h1>
    <ul id="user_list">
        <!-- User items will be loaded here by JavaScript -->
    </ul>
    <a href="/" class="back-link">Back to Home</a>

    <script>
        document.addEventListener('DOMContentLoaded', fetchUsers);

        function fetchUsers() {
            fetch('/api/users')
                .then(response => response.json())
                .then(users => {
                    const userList = document.getElementById('user_list');
                    userList.innerHTML = ''; // Clear existing list
                    if (users.length === 0) {
                        userList.innerHTML = '<p>No users registered yet.</p>';
                        return;
                    }
                    users.forEach(user => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <span class="user-name">${user}</span>
                            <div class="actions">
                                <button class="view-btn" onclick="viewUser('${user}')">View</button>
                                <button class="rename-btn" onclick="renameUser('${user}')">Rename</button>
                                <button class="delete-btn" onclick="deleteUser('${user}')">Delete</button>
                            </div>
                        `;
                        userList.appendChild(listItem);
                    });
                })
                .catch(error => {
                    console.error('Error fetching users:', error);
                    document.getElementById('user_list').innerHTML = '<p>Error loading users.</p>';
                });
        }

        function viewUser(userName) {
            window.location.href = `/users/${userName}`;
        }

        function renameUser(oldName) {
            const newName = prompt(`Enter new name for ${oldName}:`);
            if (newName && newName.trim() !== '' && newName !== oldName) {
                fetch(`/api/users/rename/${oldName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ new_name: newName.trim() }),
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        fetchUsers(); // Refresh the list
                    }
                })
                .catch(error => {
                    console.error('Error renaming user:', error);
                    alert('An error occurred while renaming the user.');
                });
            } else if (newName !== null && newName.trim() === oldName) {
                alert('New name is the same as the old name.');
            }
        }

        function deleteUser(userName) {
            if (confirm(`Are you sure you want to delete user ${userName}? This action cannot be undone.`)) {
                fetch(`/api/users/delete/${userName}`, {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        fetchUsers(); // Refresh the list
                    }
                })
                .catch(error => {
                    console.error('Error deleting user:', error);
                    alert('An error occurred while deleting the user.');
                });
            }
        }
    </script>
</body>
</html>